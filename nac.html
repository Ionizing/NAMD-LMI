<!DOCTYPE HTML>
<html lang="en" class="rust" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Non-adiabatic Coupling - NAMD-LMI Manual</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                tags: 'ams',
                packages: {'[+]': ['physics']}
            } 
        };
        </script>
        <script type="text/javascript" id="MathJax-script" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js">
        </script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('rust')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="Introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="Installation.html">Installation</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded "><a href="overall.html"><strong aria-hidden="true">1.</strong> Overall process</a></li><li class="chapter-item expanded "><a href="nac.html" class="active"><strong aria-hidden="true">2.</strong> Non-adiabatic Coupling</a></li><li class="chapter-item expanded "><a href="hamil.html"><strong aria-hidden="true">3.</strong> Hamiltonian</a></li><li class="chapter-item expanded "><a href="surfhop.html"><strong aria-hidden="true">4.</strong> Surface Hopping</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="Feedback.html">Feedback</a></li><li class="chapter-item expanded affix "><a href="Acknowledgements.html">Acknowledgements</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NAMD-LMI Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="non-adiabatic-coupling"><a class="header" href="#non-adiabatic-coupling">Non-adiabatic Coupling</a></h1>
<p>In Hefei-NAMD non-adiabatic coupling (NAC) is defined as the derivative of
wavefunctions</p>
<p>\begin{equation}
\mathbf{D}_{jk} = \mel{\phi_j}{\dv{t}}{\phi_k}
\end{equation}</p>
<p>where $\phi$ is the Kohn-Sham (KS) orbitals calculated by VASP.</p>
<p>To simulate photo-excitations process, momentum matrix element \(\mathbf{P}_{jk}
= \mel{j}{\mathbf{p}}{k}\) is needed to calculate the light-matter interaction
(LMI) term</p>
<p>\begin{equation}
\mathcal{H}_{jk}^{\mathrm{LMI}} = -e \frac{\mathbf{A}}{m_e} \mel{j}{\mathbf{p}}{k}
\end{equation}</p>
<p>in which $\mathbf{p}$ is the momentum opeartor, and \(\mathbf{A}\) is the vector potential
of external field.</p>
<p><strong>NOTE:</strong> <code>namd_lmi</code> is capable of calculating both \(\mathbf{D}_{jk}\) and \(\mathbf{P}_{jk}\).</p>
<h2 id="help-message"><a class="header" href="#help-message">Help message</a></h2>
<pre><code class="language-shell">$ namd_lmi nac
Calculate non-adiabatic coupling (NAC) including `&lt;j| d/dt |k&gt;` and momentum matrix `&lt;i| p |j&gt;`

Usage: namd_lmi nac [OPTIONS]

Options:
  -n, --nthreads &lt;NTHREADS&gt;
          Number of threads for parallel calculation.

          If 0 is set, it will fall back to the number of logic CPU cores of you machine.

          [default: 0]

  -c, --config &lt;CONFIG&gt;
          Config file name.

          Aliases: "cfg", "conf".

          [default: nac_config.toml]

      --generate &lt;GENERATE&gt;
          Generate auxiliary files for the calculation and analysis.

          The calculation will not run if this flag is set.

          Alias: "gen"

          Possible values:
          - config-template:      Generate config template for NAC calculation. Aliases: "config", "cfg", "conf"
          - postprocess-template: Generate post-process scripts for NAC analysis. Aliases: "post-process", "postprocess", "pp"

  -h, --help
          Print help (see a summary with '-h')
</code></pre>
<h2 id="procedures"><a class="header" href="#procedures">Procedures</a></h2>
<ol>
<li>
<p>Generate a configuration template.</p>
<pre><code class="language-shell">$ namd_lmi nac --generate conf
2024-11-19 20:26:10 [ INFO] Global logger initialized with targets being stderr and "./globalrun.log"
2024-11-19 20:26:10 [ INFO] Writing `01_nac_config_template.toml ...`
2024-11-19 20:26:10 [ INFO] Time used: 1.351249ms
</code></pre>
<p>where the <code>01_nac_config_template.toml</code> reads</p>
<pre><code class="language-toml">		 rundir = "../run"
		ikpoint = 1
		 brange = [0, 0]
			nsw = 2000
		 ndigit = 4
		  potim = 1
	temperature = 0
phasecorrection = true
	   nacfname = "NAC.h5"
</code></pre>
</li>
<li>
<p>Modify the configuration according to your AIMD parameters.</p>
<p>If you are familiar with the original Hefei-NAMD procedure, the parameters in
<code>01_nac_config_template.toml</code> is not hard to understand:</p>
<ul>
<li><code>rundir</code> <em>string</em>: AIMD directory where thousands of SCF with WAVECARs lies within.</li>
<li><code>ikpoint</code> <em>integer</em>: Which K point to choose, the index counts from <code>1</code>. For now, you
can only choose one K point is selectable to calculate NAC and momentum
matrix elements.</li>
<li><code>brange</code> <em>[integer, integer]</em>: Selected band range for calculation. <code>[100, 120]</code> will select
band from 100 to 120 to do the calculation, 21 bands in total.</li>
<li><code>nsw</code> <em>integer</em>: Number of steps in AIMD. If there are <code>2000</code> steps in your <code>run/</code>,
this field should be <code>2000</code>.</li>
<li><code>ndigit</code> <em>integer</em>: Number of digits for the index of each step. If the directories in your
<code>run/</code> are <code>00001</code> ... <code>02000</code>, this field should be 5.</li>
<li><code>potim</code> <em>float</em>: Time step of the AIMD, consistent with the <code>POTIM</code> in INCAR during NVE.</li>
<li><code>temperature</code> <em>float</em>: Temperature of the MD, consistent with the <code>TEEND</code> in INCAR during NVT.</li>
<li><code>phasecorrection</code> <em>bool</em>: Do phase correction for the KS orbitals or not. Should be either
<code>true</code> or <code>false</code>. Usually this term is essential for the photo-excitation process.</li>
<li><code>nacfname</code> <em>string</em>: Output file name.</li>
</ul>
<p><strong>NOTE:</strong> The <em>string</em> fields must be surrounded with quotation mark <code>""</code>.</p>
</li>
<li>
<p>Do the coupling calculation.</p>
<p>This process is quite simple</p>
<pre><code class="language-shell">$ namd_lmi nac -c 01_nac_config_template.toml
2024-11-19 21:06:20 [ INFO] Global logger initialized with targets being stderr and "./globalrun.log"
2024-11-19 21:06:20 [ INFO]
+----------------------------------------------------------------------+
|                                                                      |
|    _   _            __  __  _____           _       __  __  _____    |
|   | \ | |    /\    |  \/  ||  __ \         | |     |  \/  ||_   _|   |
|   |  \| |   /  \   | \  / || |  | | ______ | |     | \  / |  | |     |
|   | . ` |  / /\ \  | |\/| || |  | ||______|| |     | |\/| |  | |     |
|   | |\  | / ____ \ | |  | || |__| |        | |____ | |  | | _| |_    |
|   |_| \_|/_/    \_\|_|  |_||_____/         |______||_|  |_||_____|   |
|                                                                      |
+----------------------------------------------------------------------+

Welcome to use namd!
    current version:    0.1.0
    git hash:           d659586
    author(s):          Ionizing
    host:               x86_64-unknown-linux-gnu
    built time:         2024-11-19 15:34:05 +08:00

2024-11-19 21:06:20 [ INFO] Running with 0 threads.
2024-11-19 21:06:20 [ INFO] Got NAC config:
####         NAMD-lmi config for Non-Adiabatic Coupling (NAC) calculation       ####
####    YOU NEED TO CHANGE THE PARAMETERS IN THE FOLLOWING TO FIT YOU SYSTEM    ####

               rundir = "../../aimd/static_ncl_40/run/"
              ikpoint = 1
               brange = [213, 220]
                  nsw = 2000
               ndigit = 4
                potim = 1
          temperature = 300
      phasecorrection = true
             nacfname = "NAC.h5"

2024-11-19 21:06:20 [ INFO] No pre-calculated NAC available, start calculating from scratch in "../../aimd/static_ncl_40/run/"/.../WAVECARs ...
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/0001" and "../../aimd/static_ncl_40/run/0002" ..., remains:   1999
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/0312" and "../../aimd/static_ncl_40/run/0313" ..., remains:   1998
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1000" and "../../aimd/static_ncl_40/run/1001" ..., remains:   1997
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/0218" and "../../aimd/static_ncl_40/run/0219" ..., remains:   1996
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/0078" and "../../aimd/static_ncl_40/run/0079" ..., remains:   1995
2024-11-19 21:06:20 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/0132" and "../../aimd/static_ncl_40/run/0133" ..., remains:   1994
...
2024-11-19 21:08:31 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1370" and "../../aimd/static_ncl_40/run/1371" ..., remains:      5
2024-11-19 21:08:31 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1358" and "../../aimd/static_ncl_40/run/1359" ..., remains:      4
2024-11-19 21:08:31 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1216" and "../../aimd/static_ncl_40/run/1217" ..., remains:      3
2024-11-19 21:08:31 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1217" and "../../aimd/static_ncl_40/run/1218" ..., remains:      2
2024-11-19 21:08:31 [ INFO]  Calculating couplings between "../../aimd/static_ncl_40/run/1215" and "../../aimd/static_ncl_40/run/1216" ..., remains:      1
2024-11-19 21:08:32 [ INFO] Time used: 72.490979406s
</code></pre>
<p><code>namd_lmi nac</code> uses <a href="https://github.com/rayon-rs/rayon"><code>rayon</code></a> to utilize
multi-threaded parallelism and you can specify the number of threads used by
this command via <code>-n/--nthreads</code>. For example
<code>namd_lmi -c 01_nac_config_template.toml -n 32</code> uses 32 threads to calculate
the couplings.</p>
</li>
<li>
<p>Visualize couplings</p>
<p>Run <code>namd_lmi nac --generate pp</code> to get a Python script to visualize the
produced <code>NAC.h5</code></p>
<pre><code class="language-shell">$ namd_lmi nac --generate pp
2024-11-19 21:14:22 [ INFO] Global logger initialized with targets being stderr and "./globalrun.log"
2024-11-19 21:14:22 [ INFO] Writing `nac_plot.py` ...
2024-11-19 21:14:22 [ INFO] Time used: 1.241002ms 

$ python3 ./nac_plot.py
Writing nac_bands.png
Writing nac_nac.png
</code></pre>
<p>And the produced <code>.pngs</code> should look like</p>
<p><img src="./nac_bands.png" alt="nac_bands.png" />
<img src="./nac_nac.png" alt="nac_nac.png" /></p>
<p>You can modify <code>nac_plot.py</code> to visualize whatever you want.</p>
</li>
</ol>
<h2 id="data-fields-of-nach5"><a class="header" href="#data-fields-of-nach5">Data fields of <code>NAC.h5</code></a></h2>
<pre><code>$ h5dump -H NAC.h5
HDF5 "NAC.h5" {
GROUP "/" {
   DATASET "brange" {
      DATATYPE  H5T_ARRAY { [2] H5T_STD_U64LE }
      DATASPACE  SCALAR
   }
   DATASET "efermi" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SCALAR
   }
   DATASET "eigs" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 1, 8 ) / ( 1999, 1, 8 ) }
   }
   DATASET "ikpoint" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "nbands" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "nbrange" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "ndigit" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "nspin" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "nsw" {
      DATATYPE  H5T_STD_U64LE
      DATASPACE  SCALAR
   }
   DATASET "olaps_i" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 1, 8, 8 ) / ( 1999, 1, 8, 8 ) }
   }
   DATASET "olaps_r" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 1, 8, 8 ) / ( 1999, 1, 8, 8 ) }
   }
   DATASET "phasecorrection" {
      DATATYPE  H5T_ENUM {
         H5T_STD_I8LE;
         "FALSE"            0;
         "TRUE"             1;
      }
      DATASPACE  SCALAR
   }
   DATASET "pij_i" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 1, 3, 8, 8 ) / ( 1999, 1, 3, 8, 8 ) }
   }
   DATASET "pij_r" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 1, 3, 8, 8 ) / ( 1999, 1, 3, 8, 8 ) }
   }
   DATASET "potim" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SCALAR
   }
   DATASET "proj" {             // This part is cropped from PROCARs
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SIMPLE { ( 1999, 4, 8, 36, 9 ) / ( 1999, 4, 8, 36, 9 ) }
   }
   DATASET "temperature" {
      DATATYPE  H5T_IEEE_F64LE
      DATASPACE  SCALAR
   }
}
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="overall.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="hamil.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="overall.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="hamil.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
